<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>IBAN DOƒûRULAMA</title>

<style>
*, *::before, *::after { box-sizing: border-box; }
html, body { height: 100%; margin:0; }

:root{
  --bg:#eef2f7;
  --card-bg:#ffffffcc;
  --text:#111;
  --border:rgba(0,0,0,.15);

  --logo-color:#111;
  --logo-sub:#006CFF;

  --footer-circle:#006CFF;
  --footer-text:#111;
  --footer-sub:#006CFF;

  --success:#7CCF90;
  --error:rgba(255,0,0,.26);

  --button:linear-gradient(135deg,#006CFF,#4A2CFF);
  --button-hover:linear-gradient(135deg,#0052e6,#3a24d9);

  --switch-bg:#bbb;
  --switch-knob:#fff;

  --switch-sun:#f7c235;
  --switch-moon:#fff;
}

body.dark{
  --bg:#07090d;
  --card-bg:#1e1e1ecc;
  --text:#fff;

  --logo-color:#fff;
  --logo-sub:#66B3FF;

  --footer-circle:#66B3FF;
  --footer-text:#fff;
  --footer-sub:#66B3FF;

  --switch-bg:#444;
  --switch-knob:#fff;

  --switch-sun:#444;
  --switch-moon:#fff;
}

body{
  font-family:"Segoe UI", Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  transition:.3s;
}

@keyframes shake {
  0% { transform: translateX(0); }
  20% { transform: translateX(-4px); }
  40% { transform: translateX(4px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
  100% { transform: translateX(0); }
}
.input-error {
  border-color: red !important;
  animation: shake .35s ease;
}

#rightTop{
  position:fixed; top:25px; right:40px;
}

#rightTop .sun-fixed,
#rightTop .moon-fixed {
  position: absolute;
  width: 18px;
  height: 18px;
  top: 50%;
  transform: translateY(-50%);
  transition: opacity .25s;
}

#rightTop .sun-fixed {
  left: -28px;
  opacity: 1;
  stroke: var(--switch-sun);
  fill: none;
}

#rightTop .moon-fixed {
  left: -28px;
  opacity: 0;
  stroke: var(--switch-moon);
  fill: none;
}

body.dark #rightTop .sun-fixed { opacity: 0; }
body.dark #rightTop .moon-fixed { opacity: 1; }

.switch { width: 54px; height: 30px; position: relative; display:inline-block;}
.switch input { display:none; }
.slider {
  position:absolute; inset:0;
  background:var(--switch-bg);
  border-radius:30px;
  transition:.35s;
  cursor:pointer;
}
.switch-handle {
  position:absolute; width:26px; height:26px;
  background:var(--switch-knob);
  border-radius:50%;
  top:2px; left:2px;
  transition:.35s cubic-bezier(.4,0,.2,1);
  box-shadow:0 2px 6px rgba(0,0,0,.25);
}
input:checked + .slider { background:#34C759; }
input:checked + .slider .switch-handle { transform:translateX(24px); }

#logoBox{
  position:fixed;
  top:25px; left:25px;
  cursor:pointer;
  transition:.2s;
}
#logoBox:hover{ transform:scale(1.05); }

.logo-main{ fill:var(--logo-color); }
.logo-sub{ fill:var(--logo-sub); }

.kutu{
  width:min(650px,92vw);
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:18px;
  padding:35px;
  margin-top:40px;
  backdrop-filter:blur(18px);
}

.input-wrap{ position:relative; width:100%; }

#iban{
  width:100%; height:52px;
  padding:0 56px 0 18px;
  border:1px solid var(--border);
  border-radius:12px;
  font-size:18px;
  background:#fff8;
  color:var(--text);
}
body.dark #iban{ background:#333a; color:#fff; }

.paste-btn{
  position:absolute;
  right:12px; top:50%;
  transform:translateY(-50%);
  font-size:22px; cursor:pointer;
}

button.action{
  width:100%; height:58px;
  border:none;
  margin-top:25px;
  background:var(--button);
  color:#fff;
  border-radius:16px;
  font-size:20px;
  font-weight:700;
}
button.action:hover{
  transform:scale(1.03);
  background:var(--button-hover);
}

.sonuc{
  display:none;
  margin-top:20px;
  padding:16px 22px;
  border-radius:12px;
  font-size:20px;
  font-weight:600;
  color:white;
}
.ok{ background:var(--success); }
.err{ background:var(--error); }

.result-flex{
  display:flex;
  justify-content:space-between;
}

#altFooter{
  position:fixed; bottom:25px; right:25px;
}

#footerLogo{
  display:flex; align-items:center;
  gap:10px;
}

.footer-circle{
  fill:var(--footer-circle);
}

.footer-name{ font-size:15px; font-weight:700; color:var(--footer-text); }
.footer-mail{ font-size:12px; font-weight:600; color:var(--footer-sub); }

/* METƒ∞N HALƒ∞NDE ƒ∞STATƒ∞STƒ∞K */
#istatistik {
  text-align:center;
  font-weight:600;
  margin-bottom:12px;
  opacity:.9;
}

/* ======== (EK) SOHBET Bƒ∞LE≈ûENLERƒ∞ ‚Äì stil (kƒ±saltƒ±lmadƒ±) ======== */
.chat-fab{
  position:fixed; left:24px; bottom:24px; z-index:9998;
  height:46px; padding:0 18px; border:none; border-radius:23px;
  background:var(--button); color:#fff; font-weight:700; cursor:pointer;
  box-shadow:0 8px 18px rgba(0,0,0,.18);
}
.chat-fab:hover{ background:var(--button-hover); transform:translateY(-1px) }

#chatDock{
  position:fixed; left:24px; bottom:84px; z-index:9999;
  width:360px; background:var(--card-bg); border:1px solid var(--border);
  border-radius:16px; backdrop-filter:blur(14px);
  box-shadow:0 14px 38px rgba(0,0,0,.16); font-size:14px; color:var(--text);
  display:none;
}
#chatDock.open{ display:block; }

#chatDock header{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,rgba(0,108,255,.08),rgba(74,44,255,.06));
  border-radius:16px 16px 0 0;
}
#chatDock .users{
  padding:8px 12px; display:flex; flex-wrap:wrap; gap:6px; border-bottom:1px solid var(--border)
}
#chatDock .users .u{
  padding:4px 8px; border:1px solid var(--border);
  border-radius:10px; background:#fff6
}
#chatDock .messages{ height:230px; overflow:auto; padding:12px 12px }
#chatDock .msg{ display:flex; align-items:flex-start; gap:6px; margin-bottom:10px }
#chatDock .msg .nick{ min-width:88px; max-width:140px; font-weight:700; opacity:.9 }
#chatDock .msg .txt{ flex:1; background:#fff; border:1px solid var(--border); padding:6px 8px; border-radius:10px; word-break:break-word; background:#fff9 }

/* üëë Erol i√ßin ta√ß hizalama */
.msg .crown { display:inline-block; margin-right:6px; }

#chatDock .inputBar{
  display:flex; gap:8px; padding:10px 12px; border-top:1px solid var(--border);
  border-radius:0 0 16px 16px; background:linear-gradient(135deg,rgba(0,108,255,.06),rgba(74,44,255,.04));
}
#chosenNick{
  height:36px; display:flex; align-items:center; padding:0 10px;
  border:1px solid var(--border); border-radius:10px; background:#fff8; color:var(--text);
}
#chatInput{
  flex:1; height:36px; border:1px solid var(--border);
  border-radius:10px; padding:0 10px; background:#fff8; color:var(--text)
}
#chatSend{
  height:36px; border:none; border-radius:10px; padding:0 14px;
  background:var(--button); color:#fff; font-weight:800
}
#chatSend:hover{ background:var(--button-hover); transform:translateY(-1px) }

#chatMinimize{ background:transparent; border:none; font-size:18px; cursor:pointer; color:var(--text); opacity:.7; }
#chatMinimize:hover{ opacity:1 }

#chatStatus{ font:12px/1.4 Segoe UI,Arial; color:#b00020; padding:6px 12px 10px; min-height:16px; }

/* Sabit mesaj bandƒ± */
#pinnedBanner{
  display:none;
  background:#fffbcc;
  border-bottom:1px solid #e6de8a;
  padding:8px 12px;
  font-weight:600;
}
#pinnedActions{
  display:none; gap:6px; padding:4px 12px; border-bottom:1px solid var(--border);
}
#typingInfo{ font-size:12px; padding:4px 12px; opacity:.8; }

/* === (EK) Masa√ºst√º Bildirim ƒ∞zin Paneli (√ßakƒ±≈ümasƒ±n diye saƒü altta) === */
#ntfHelper{
  position: fixed;
  right: 24px;
  bottom: 100px; /* footer √ºst√ºnde */
  z-index: 2147483647;
  background: var(--button);
  color: #fff;
  font: 13px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  padding: 10px 12px;
  border-radius: 10px;
  box-shadow: 0 6px 24px rgba(0,0,0,.25);
  display: none;
  max-width: 340px;
}
#ntfHelper.show { display:block; }
#ntfHelper h3 { margin: 0 0 6px 0; font-size: 14px; font-weight: 700; }
#ntfHelper p { margin: 0 0 10px 0; opacity: .95; }
#ntfHelper .row { display:flex; gap:8px; flex-wrap:wrap; }
#ntfHelper button {
  appearance: none; border: none; border-radius: 8px;
  padding: 8px 12px; font-weight: 700; cursor: pointer;
  background: #fff; color: #0b5cff;
}
#ntfHelper button.secondary {
  background: rgba(255,255,255,.15); color: #fff;
}
</style>
</head>

<body>

<!-- LOGO -->
<div id="logoBox" onclick="location.reload()">
  <svg width="230" height="60" viewBox="0 0 330 90">
    <circle cx="45" cy="45" r="28" class="logo-sub"></circle>
    <path d="M34 45l10 10 18-24"
      stroke="white" stroke-width="7"
      fill="none" stroke-linecap="round" stroke-linejoin="round"></path>

    <text x="95" y="43" font-size="36" font-weight="700" class="logo-main">IBAN</text>
    <text x="95" y="72" font-size="24" font-weight="700" class="logo-sub">DOƒûRULAMA</text>
  </svg>
</div>

<!-- TEMA SWITCH -->
<div id="rightTop">
  <svg class="sun-fixed" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="4"></circle>
    <line x1="12" y1="1" x2="12" y2="4"></line>
    <line x1="12" y1="20" x2="12" y2="23"></line>
    <line x1="1" y1="12" x2="4" y2="12"></line>
    <line x1="20" y1="12" x2="23" y2="12"></line>
    <line x1="4" y1="4" x2="6" y2="6"></line>
    <line x1="18" y1="18" x2="20" y2="20"></line>
    <line x1="4" y1="20" x2="6" y2="18"></line>
    <line x1="18" y1="6" x2="20" y2="4"></line>
  </svg>

  <svg class="moon-fixed" viewBox="0 0 24 24">
    <path d="M21 12.79A9 9 0 0 1 12.21 3 7 7 0 1 0 21 12.79z"></path>
  </svg>

  <label class="switch">
    <input type="checkbox" id="themeToggle">
    <span class="slider"><div class="switch-handle"></div></span>
  </label>
</div>

<!-- ANA KART -->
<div class="kutu" id="mainCard">

  <!-- METƒ∞N HALƒ∞NDE A√áIKLAMA + SAYI -->
  <div id="istatistik">Bir IBAN numarasƒ±nƒ± doƒürulayƒ±n, bug√ºn 0 adet doƒürulama yapƒ±ldƒ±.</div>

  <div class="input-wrap">
    <input id="iban" placeholder="TR25 0000 0000 0000 0000 0000 25">
    <span class="paste-btn" onclick="pasteIBAN()">üìã</span>
  </div>

  <button class="action" onclick="ibanKontrol()">DOƒûRULA ‚Ä£</button>

  <div id="sonuc" class="sonuc"></div>
</div>

<!-- FOOTER -->
<div id="altFooter">
  <div id="footerLogo">
    <svg width="46" height="46" viewBox="0 0 80 80">
      <circle cx="40" cy="40" r="28" class="footer-circle"></circle>
      <text x="40" y="48" text-anchor="middle"
        font-family="Segoe UI" font-size="28" font-weight="700" fill="white">ET</text>
    </svg>
    <div>
      <div class="footer-name">ET√úRK</div>
      <div class="footer-mail">e.turk@palen.com.tr</div>
    </div>
  </div>
</div>

<!-- ====== (EK) SOHBET HTML ====== -->
<button id="chatFab" class="chat-fab" aria-controls="chatDock" aria-expanded="false">üí¨ Sohbet</button>

<div id="chatDock" role="dialog" aria-label="Sohbet Paneli">
  <header>
    <div style="display:flex; align-items:center; gap:8px">
      <div class="title">Sohbet</div>
      <div class="online">/ Online: <span id="onlineCount">0</span></div>
    </div>
    <button id="chatMinimize" title="Kapat">‚Äî</button>
  </header>

  <div id="pinnedBanner"></div>
  <div id="pinnedActions">
    <button id="btnPin">üìå Sabitle</button>
    <button id="btnUnpin">‚ùå Kaldƒ±r</button>
  </div>

  <div class="users" id="chatUsers"></div>
  <div id="typingInfo"></div>

  <div class="messages" id="chatMessages"></div>

  <div class="inputBar">
    <div id="chosenNick">ƒ∞sim se√ßilmedi</div>
    <input type="text" id="chatInput" placeholder="Mesaj yazƒ±n‚Ä¶" disabled>
    <button id="chatSend" disabled>G√∂nder</button>
  </div>

  <div id="chatStatus"></div>
</div>

<!-- ƒ∞Sƒ∞M SE√áƒ∞M MODALI -->
<div id="nickModal" style="position:fixed; inset:0; z-index:10000; display:none; background:rgba(0,0,0,.35);">
  <div class="card" style="width:min(420px,92vw); background:#ffffffcc; border:1px solid var(--border); border-radius:14px; padding:16px; margin:12vh auto 0; box-shadow:0 18px 40px rgba(0,0,0,.18);">
    <h3>ƒ∞sminizi se√ßin</h3>
    <div class="row" style="display:flex; gap:8px; align-items:center">
      <select id="nickSelect" style="height:38px; border:1px solid var(--border); border-radius:10px; padding:0 10px; flex:1">
        <option value="" selected disabled>Se√ßiniz‚Ä¶</option>
        <option value="Dilara">Dilara K.</option>
        <option value="Emre">Emre C.</option>
        <option value="B√º≈üra">B√º≈üra D.</option>
        <option value="Merve">Merve A.</option>
        <option value="Elif">Elif K.</option>
        <option value="Fatih">Fatih D.</option>
        <option value="Misafir">Misafir</option>
        <option value="Erol">Erol T.</option>
      </select>
      <input id="nickPwd" type="password" placeholder="≈ûifre" style="height:38px; border:1px solid var(--border); border-radius:10px; padding:0 10px; display:none">
      <button id="nickGo" style="height:38px; border:none; border-radius:10px; padding:0 14px; background:var(--button); color:#fff; font-weight:800;">Devam</button>
    </div>
  </div>
</div>

<!-- ===== IBAN KODUNUZ ‚Äì Hƒ∞√á DEƒûƒ∞≈ûTƒ∞Rƒ∞LMEDƒ∞ ===== -->
<script>
themeToggle.onchange = () =>
  document.body.classList.toggle("dark", themeToggle.checked);

iban.addEventListener("input", e=>{
  // Giri≈üi normalize et, ba≈üƒ±na TR‚Äôyi otomatik getir ve 4‚Äôl√º gruplandƒ±r
  const cleaned = e.target.value.toUpperCase().replace(/[^0-9A-Z]/g,"");
  const country = cleaned.slice(0,2);
  const rest = (country === "TR") ? cleaned.slice(2) : cleaned;
  const raw = "TR" + rest;

  let o="";
  for(let i=0;i<raw.length;i++){
    if(i>0 && i%4===0) o+=" ";
    o+=raw[i];
  }
  e.target.value=o;
});

async function pasteIBAN(){
  try{
    let t=await navigator.clipboard.readText();
    t=t.replace(/\s+/g,"").toUpperCase();
    // Panodan yapƒ±≈ütƒ±rmada da TR‚Äôyi garanti et
    const country = t.slice(0,2);
    const rest = (country === "TR") ? t.slice(2) : t;
    t = "TR" + rest;

    iban.value=t;
    iban.dispatchEvent(new Event("input"));
  }catch{}
}

const bankalar={
"001":"Merkez Bankasƒ±","010":"Ziraat Bankasƒ±","012":"Halkbank","015":"Vakƒ±fbank",
"014":"TSKB","016":"Eximbank","017":"T√ºrkiye Kalkƒ±nma Bankasƒ±",
"029":"Birle≈üik Fon Bankasƒ±","032":"TEB","034":"Aktif Yatƒ±rƒ±m Bankasƒ±",
"046":"Akbank","048":"HSBC","058":"Sƒ±nai Yatƒ±rƒ±m Bankasƒ±","059":"≈ûekerbank",
"062":"Garanti BBVA","064":"ƒ∞≈ü Bankasƒ±","067":"Yapƒ± Kredi",
"134":"Denizbank A.≈û.","091":"Arap T√ºrk Bankasƒ±","092":"Citibank","099":"ING",
"103":"Fiba Bank","106":"Portigon AG","107":"BNP-Ak-Dresdner","108":"Turkland Bank",
"109":"Tekstil Bankasƒ±","111":"Finansbank","115":"Deutsche Bank",
"125":"Burganbank","133":"ING Bank","135":"Anadolubank","157":"EnPara",
"203":"Albaraka T√ºrk","205":"Kuveyt T√ºrk","206":"T√ºrkiye Finans",
"208":"Asya Katƒ±lƒ±m","210":"Vakƒ±f Katƒ±lƒ±m","223":"Albaraka T√ºrk Katƒ±lƒ±m"
};

function mod97(i){
  const r=i.slice(4)+i.slice(0,4);
  const c=r.replace(/[A-Z]/g,ch=>ch.charCodeAt(0)-55);
  let m=0;
  for(let i=0;i<c.length;i++) m=(m*10+Number(c[i]))%97;
  return m===1;
}

/* G√úNL√úK DOƒûRULAMA SAYACI (local yedek) */
const LS_KEY="ibanDailyStats";

function todayStr(){
  const d=new Date();
  return d.toISOString().slice(0,10); // YYYY-MM-DD
}

function loadStats(){
  try{
    const j=localStorage.getItem(LS_KEY);
    if(!j) return {date:todayStr(), count:0};
    const data=JSON.parse(j);
    if(data.date !== todayStr())
      return {date:todayStr(), count:0};
    return data;
  }catch{ return {date:todayStr(), count:0}; }
}
function saveStats(obj){
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}
function updateIstatistikLocal(){
  const st=loadStats();
  document.getElementById("istatistik").textContent =
    `Bir IBAN numarasƒ±nƒ± doƒürulayƒ±n, bug√ºn ${st.count} adet doƒürulama yapƒ±ldƒ±.`;
}

document.addEventListener("DOMContentLoaded", updateIstatistikLocal);

/* === IBAN KONTROL === */
async function ibanKontrol(){
  const v=iban.value.replace(/\s+/g,"");
  const s=document.getElementById("sonuc");

  if(!v.startsWith("TR") || v.length!==26)
    return hata("IBAN GE√áERSƒ∞Z!");
  if(!mod97(v))
    return hata("IBAN GE√áERSƒ∞Z!");

  // 1) Local saya√ß (yedek)
  const st=loadStats(); st.count++; saveStats(st);

  // 2) Supabase‚Äôe kaydet (genel saya√ß i√ßin)
  try{
    await postGlobalValidation();  // g√ºncellenmi≈ü fonksiyon (a≈üaƒüƒ±da)
  }catch(e){
    // Sessiz ge√ß ‚Äì baƒülantƒ± yoksa local g√∂r√ºns√ºn
    console.warn("Genel saya√ß yazƒ±lamadƒ±:", e);
  }

  // 3) Ekran metnini genel sayƒ±yla g√ºncelle
  await refreshGlobalCounter();

  const kod=v.slice(6,9);
  s.className="sonuc ok";
  s.style.display="block";
  s.innerHTML = `
    <div class="result-flex">
      <div>‚úî IBAN GE√áERLƒ∞</div>
      <div>${bankalar[kod] ?? ""}</div>
    </div>`;
}

function hata(msg){
  const s=document.getElementById("sonuc");
  const card=document.getElementById("mainCard");

  s.className="sonuc err";
  s.style.display="block";
  s.textContent=msg;

  iban.classList.add("input-error");
  setTimeout(()=> iban.classList.remove("input-error"), 500);

  card.classList.add("snake");
  setTimeout(()=> card.classList.remove("snake"),650);
}
</script>

<!-- ===== (EK) MASA√úST√ú Bƒ∞LDƒ∞Rƒ∞M MOD√úL√ú ‚Äì SOHBET ===== -->
<div id="ntfHelper" role="region" aria-live="polite" aria-label="Bildirim izni">
  <h3>Sohbet Bildirimleri</h3>
  <p>Yeni mesajlar i√ßin masa√ºst√º bildirimi g√∂sterebilmemiz adƒ±na l√ºtfen izin verin.</p>
  <div class="row">
    <button id="ntfGrant" type="button">ƒ∞zin Ver</button>
    <button id="ntfHide" type="button" class="secondary">Gizle</button>
  </div>
</div>

<script>
/* Bu mod√ºl mevcut kodu BOZMADAN √ßalƒ±≈üƒ±r.
   Dƒ±≈ü API: window.notifyNewMessage({from, text, url?, tag?, force?})
   Opsiyon: window.setNotificationOptions({...})
*/
(function(){
  const defaults = {
    appName: 'Sohbet',
    icon: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0ea5e9"/>
            <stop offset="1" stop-color="#22c55e"/>
          </linearGradient>
        </defs>
        <g fill="url(#g)">
          <path d="M4 5.5A3.5 3.5 0 0 1 7.5 2h9A3.5 3.5 0 0 1 20 5.5v6A3.5 3.5 0 0 1 16.5 15H10l-3.6 2.7A1 1 0 0 1 5 16.9V15.5A3.5 3.5 0 0 1 4 11.5v-6Z"/>
          <circle cx="9" cy="9" r="1.25"/>
          <circle cx="12.5" cy="9" r="1.25"/>
          <circle cx="16" cy="9" r="1.25"/>
        </g>
      </svg>
    `),
    badge: undefined,
    requireInteraction: false,
    silent: false,
    durationMs: 8000,
    clickBehavior: 'focus',   // 'focus' | 'open' | 'none'
    clickUrl: null,
    showWhenFocused: false
  };

  const state = { options: { ...defaults }, queue: [] };
  const $ = (id) => document.getElementById(id);

  function canNotify(){ return 'Notification' in window; }
  function isFocused(){ return document.visibilityState === 'visible' && document.hasFocus(); }

  function showHelper(){ $('ntfHelper')?.classList.add('show'); }
  function hideHelper(){ $('ntfHelper')?.classList.remove('show'); }

  async function ensurePermission(){
    if(!canNotify()) return false;
    if(Notification.permission === 'granted') return true;
    if(Notification.permission === 'denied'){ showHelper(); return false; }
    try{
      const res = await Notification.requestPermission();
      if(res === 'granted') return true;
      showHelper(); return false;
    }catch{ showHelper(); return false; }
  }

  async function showNotification({ title, body, icon, badge, tag, data, clickUrl, requireInteraction, silent, durationMs }){
    if(!await ensurePermission()) return;
    let n;
    try{
      n = new Notification(title || state.options.appName, {
        body: body || '',
        icon: icon ?? state.options.icon,
        badge: badge ?? state.options.badge,
        tag,
        data,
        requireInteraction: requireInteraction ?? state.options.requireInteraction,
        silent: silent ?? state.options.silent
      });
    }catch{ return; }

    n.onclick = (ev) => {
      try{ ev.preventDefault?.(); }catch{}
      try{
        const behavior = state.options.clickBehavior;
        if(behavior === 'focus'){ window.focus(); }
        else if(behavior === 'open'){
          const url = clickUrl ?? state.options.clickUrl;
          if(url) window.open(url, '_blank', 'noopener,noreferrer');
        }
      }catch{}
      try{ n.close(); }catch{}
    };

    const timeout = (durationMs ?? state.options.durationMs);
    if(!n.requireInteraction && Number.isFinite(timeout) && timeout > 0){
      setTimeout(()=>{ try{ n.close(); }catch{} }, timeout);
    }
  }

  function shouldShow(force){
    if(force === true) return true;
    return !isFocused() || state.options.showWhenFocused === true;
  }

  async function handleIncomingMessage(msg){
    // msg: { from, text, title?, url?, tag?, force? }
    const { from, text, title, url, tag, force } = msg || {};
    if(!shouldShow(force)) return;
    const finalTitle = title || `${state.options.appName}${from ? ' ‚Ä¢ ' + from : ''}`;
    const body = (text ?? '').toString().slice(0, 500);
    await showNotification({ title: finalTitle, body, tag, clickUrl: url });
  }

  // Dƒ±≈ü API
  window.notifyNewMessage = function(payload){
    // ƒ∞zin hen√ºz 'default' ise kuyrukla
    if(canNotify() && Notification.permission === 'default'){
      state.queue.push(payload);
      ensurePermission().then(granted=>{
        if(granted){
          const q = state.queue.slice();
          state.queue.length = 0;
          q.forEach(item => handleIncomingMessage(item));
        }
      });
      showHelper();
      return;
    }
    handleIncomingMessage(payload);
  };

  window.setNotificationOptions = function(opts = {}){
    state.options = { ...state.options, ...opts };
  };

  // Panel butonlarƒ±
  $('ntfGrant')?.addEventListener('click', async ()=>{
    await ensurePermission(); hideHelper();
    if(state.queue.length){
      const q = state.queue.slice();
      state.queue.length = 0;
      q.forEach(item => handleIncomingMessage(item));
    }
  });
  $('ntfHide')?.addEventListener('click', hideHelper);

  // Y√ºklemede sessiz izin denemesi
  (async ()=>{
    if(canNotify() && Notification.permission === 'default'){
      try{ await Notification.requestPermission(); }catch{}
    }
    if(canNotify() && Notification.permission === 'denied') showHelper();
  })();
})();
</script>

<!-- ===== SOHBET (REST) ‚Äì (√∂nceki son hal) + GENEL SAYA√á ENTEGRASYONU + üëë TA√á ===== -->
<script>
(function(){
  /* === Supabase REST yapƒ±landƒ±rmasƒ± (GENEL KULLANIM) === */
  const SUPABASE_URL = "https://luyhfyhwqyzwdjpcfyyn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_FftwyHK-9ZkFEp37Ejrv6A_ctj6mLFy";
  const REST = SUPABASE_URL + "/rest/v1";
  const HDR = {
    "Content-Type":"application/json",
    "apikey": SUPABASE_KEY,
    "Authorization": "Bearer "+SUPABASE_KEY
  };
  const HDR_UPSERT = { ...HDR, "Prefer":"resolution=merge-duplicates" };

  const $ = id => document.getElementById(id);
  const day = () => new Date().toISOString().slice(0,10);
  const agoIso = (sec) => new Date(Date.now()-sec*1000).toISOString();

  /* ====== GENEL IBAN SAYA√á: REST Yardƒ±mcƒ±larƒ± ====== */
  async function postGlobalValidation(){
    const body = JSON.stringify([{ day: day() }]);
    const r = await fetch(`${REST}/iban_validations?select=ts`, { method:"POST", headers:HDR, body });
    if(!r.ok) throw new Error("iban_validations insert hata: "+r.status);
  }
  async function getGlobalCount(){
    // Basit y√∂ntem: bug√ºn√ºn t√ºm satƒ±rlarƒ±nƒ± √ßekip say
    const r = await fetch(`${REST}/iban_validations?day=eq.${day()}&select=ts`, { headers:HDR });
    if(!r.ok) throw new Error("iban_validations select hata: "+r.status);
    const d = await r.json();
    return d.length|0;
  }
  async function refreshGlobalCounter(){
    try{
      const c = await getGlobalCount();
      $("istatistik").textContent = `Bir IBAN numarasƒ±nƒ± doƒürulayƒ±n, bug√ºn ${c} adet doƒürulama yapƒ±ldƒ±.`;
    }catch{
      // eri≈üilemezse local‚Äôe geri d√º≈ü
      const st = JSON.parse(localStorage.getItem("ibanDailyStats")||'{"date":"'+day()+'","count":0}');
      $("istatistik").textContent = `Bir IBAN numarasƒ±nƒ± doƒürulayƒ±n, bug√ºn ${st.count} adet doƒürulama yapƒ±ldƒ±.`;
    }
  }
  // Ekranƒ± canlƒ± tutmak i√ßin 5 sn‚Äôde bir √ßek
  setInterval(refreshGlobalCounter, 5000);
  // ƒ∞lk y√ºklemede de √ßek
  refreshGlobalCounter();

  // Bu iki fonksiyonu global alanda da kullanabilelim:
  window.postGlobalValidation = postGlobalValidation;
  window.refreshGlobalCounter = refreshGlobalCounter;

  /* ====== A≈ûAƒûIDA CHAT KODUNUZ (√∂nceki son hal) ====== */
  const usersEl=$("chatUsers"), messagesEl=$("chatMessages"), onlineEl=$("onlineCount");
  const inputEl=$("chatInput"), sendBtn=$("chatSend"), badge=$("chosenNick"), statusEl=$("chatStatus");
  const nickModal=$("nickModal"), nickSel=$("nickSelect"), nickPwd=$("nickPwd"), nickGo=$("nickGo");
  const pinnedBanner = $("pinnedBanner"), pinnedActions = $("pinnedActions");
  const btnPin = $("btnPin"), btnUnpin = $("btnUnpin"), typingInfo = $("typingInfo");
  const fab = $("chatFab"), dock = $("chatDock"), minimize = $("chatMinimize");

  let NICK = localStorage.getItem("CHAT_NICK") || "";
  if(NICK){ badge.textContent=NICK; inputEl.disabled=false; sendBtn.disabled=false; }

  /* === Sesli bildirim (WebAudio) === */
  let audioCtx=null;
  function playBeep(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(audioCtx.destination);
      const t=audioCtx.currentTime;
      o.start(t); g.gain.setValueAtTime(0.2,t);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.18);
      o.stop(t+0.2);
    }catch{}
  }
  window.addEventListener("click", ()=>{ if(!audioCtx){ try{ audioCtx= new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }, { once:true });

  /* === A√ß/Kapa === */
  fab.addEventListener("click", ()=>{ if(!NICK) nickModal.style.display="block"; else openChat(); });
  minimize.addEventListener("click", closeChat);
  function openChat(){ dock.classList.add("open");  fab.setAttribute("aria-expanded","true"); }
  function closeChat(){ dock.classList.remove("open"); fab.setAttribute("aria-expanded","false"); }

  /* === ƒ∞sim se√ßimi === */
  nickSel.addEventListener("change", ()=>{ nickPwd.style.display = (nickSel.value==="Erol") ? "block":"none"; });
  nickGo.addEventListener("click", ()=>{
    const v = nickSel.value;
    if(!v) return alert("L√ºtfen bir isim se√ßin.");
    if(v==="Erol" && nickPwd.value!=="2311") return alert("≈ûifre hatalƒ±.");
    NICK=v; localStorage.setItem("CHAT_NICK",NICK);
    badge.textContent=NICK; inputEl.disabled=false; sendBtn.disabled=false;
    nickModal.style.display="none"; openChat();
    showAdminActionsIfAny();
  });

  function showAdminActionsIfAny(){
    if(NICK==="Erol"){ pinnedActions.style.display="flex"; }
    else{ pinnedActions.style.display="none"; }
  }
  showAdminActionsIfAny();

  /* === Sabit mesaj (nick='__PIN__') === */
  async function setPinned(text){
    try{
      const body = JSON.stringify([{ day:day(), nick:"__PIN__", text }]);
      const r = await fetch(`${REST}/messages`, { method:"POST", headers:HDR, body });
      if(!r.ok) throw new Error("Sabit mesaj kaydedilemedi: "+r.status);
      await loadPinned();
      setStatus("Sabit mesaj g√ºncellendi.", "ok");
    }catch(e){ setStatus(e.message); }
  }
  async function loadPinned(){
    try{
      const url = `${REST}/messages?day=eq.${day()}&nick=eq.__PIN__&select=text,ts&order=ts.desc&limit=1`;
      const r = await fetch(url, { headers:HDR });
      if(!r.ok) throw new Error("Sabit mesaj alƒ±namadƒ±: "+r.status);
      const d = await r.json();
      const txt = (d[0]?.text||"").trim();
      if(txt){
        pinnedBanner.style.display="block";
        pinnedBanner.textContent = "üìå " + txt;
      }else{
        pinnedBanner.style.display="none";
        pinnedBanner.textContent = "";
      }
    }catch(e){ /* sessiz */ }
  }
  btnPin?.addEventListener("click", ()=>{
    const t = prompt("Sabitlenecek mesaj:");
    if(t!==null) setPinned(t.trim());
  });
  btnUnpin?.addEventListener("click", ()=> setPinned(""));

  /* === Mesaj g√∂nderme === */
  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", e=>{
    if(e.key==="Enter") send();
    triggerTyping();
  });

  async function send(){
    const text = inputEl.value.trim();
    if(!text) return;
    try{
      const body = JSON.stringify([{ day:day(), nick:NICK||"Misafir", text }]);
      const r = await fetch(`${REST}/messages`, { method:"POST", headers:HDR, body });
      if(!r.ok){
        const t = await r.text(); throw new Error("Mesaj g√∂nderilemedi: "+r.status+" "+t);
      }
      inputEl.value="";
      setStatus("G√∂nderildi.","ok");
      setTimeout(loadMessages, 250);
    }catch(e){ setStatus(e.message); }
  }

  /* === Mesajlarƒ± √ßekme + yeni mesaj algƒ±lama === */
  let lastMsgTs="";
  async function loadMessages(){
    try{
      const url = `${REST}/messages?day=eq.${day()}&select=nick,text,ts&order=ts.asc&limit=500`;
      const r = await fetch(url, { headers:HDR });
      if(!r.ok) throw new Error("Mesajlar alƒ±namadƒ±: "+r.status);
      const data = await r.json();

      const list = data.filter(m => m.nick!=="__PIN__");
      const newestMsg = list[list.length-1] || null;
      const newest = newestMsg?.ts || "";
      const hadOld = !!lastMsgTs;
      const gotNewFromOther = hadOld && newest && newest!==lastMsgTs && (newestMsg?.nick !== (NICK||"Misafir"));
      lastMsgTs = newest;

      messagesEl.innerHTML = "";
      list.forEach(m=>{
        const crown = (m.nick === "Erol" || m.nick === "Erol T." || m.nick === "Erol T") ? `<span class="crown">üëë</span>` : "";
        const nickHtml = `${crown}${m.nick}`;
        const row = document.createElement("div"); row.className="msg";
        row.innerHTML = `<div class="nick">${nickHtml}</div><div class="txt">${m.text}</div>`;
        messagesEl.appendChild(row);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;

      if(gotNewFromOther){
        // Mevcut sesli uyarƒ± + MASA√úST√ú Bƒ∞LDƒ∞Rƒ∞M
        playBeep();
        if (window.notifyNewMessage) {
          window.notifyNewMessage({
            from: newestMsg.nick,
            text: newestMsg.text,
            tag: "chat-" + (newestMsg.ts || ""),
            url: null
          });
        }
      }

    }catch(e){ setStatus(e.message); }
  }

  /* === Online sayacƒ± === */
  async function heartbeat(){
    if(!NICK) return;
    try{
      const body = JSON.stringify([{ day:day(), nick:NICK, last_seen:new Date().toISOString() }]);
      await fetch(`${REST}/presence?on_conflict=day,nick`, { method:"POST", headers:HDR_UPSERT, body });
    }catch(e){ /* sessiz */ }
  }
  async function loadOnline(){
    try{
      const threshold = agoIso(40);
      const url = `${REST}/presence?select=nick,last_seen&day=eq.${day()}&last_seen=gt.${encodeURIComponent(threshold)}`;
      const r = await fetch(url, { headers:HDR });
      if(!r.ok) throw new Error("Online listesi alƒ±namadƒ±: "+r.status);
      const data = await r.json();

      const pure = data.filter(p => !p.nick.endsWith("#typing") && p.nick!=="__PIN__");
      onlineEl.textContent = pure.length;
      usersEl.innerHTML = pure.map(p=>`<div class="u">${p.nick}</div>`).join("");

    }catch(e){ /* sessiz */ }
  }

  /* === ‚ÄúYazƒ±yor‚Ä¶‚Äù g√∂stergesi (presence'ta #typing kayƒ±tlarƒ±) === */
  let typingTimer=null, typingPulse=null, isTyping=false;

  function triggerTyping(){
    if(!NICK) return;
    if(!isTyping){
      isTyping=true;
      sendTypingPulse();
      typingPulse = setInterval(sendTypingPulse, 3000);
    }
    clearTimeout(typingTimer);
    typingTimer = setTimeout(stopTyping, 2000);
  }
  function stopTyping(){
    isTyping=false;
    clearInterval(typingPulse); typingPulse=null;
  }
  async function sendTypingPulse(){
    try{
      const body = JSON.stringify([{ day:day(), nick: (NICK+"#typing"), last_seen:new Date().toISOString() }]);
      await fetch(`${REST}/presence?on_conflict=day,nick`, { method:"POST", headers:HDR_UPSERT, body });
    }catch{}
  }
  async function loadTyping(){
    try{
      const threshold = agoIso(3);
      const url = `${REST}/presence?select=nick,last_seen&day=eq.${day()}&last_seen=gt.${encodeURIComponent(threshold)}`;
      const r = await fetch(url, { headers:HDR });
      if(!r.ok) return;
      const data = await r.json();
      const typers = data
        .filter(p => p.nick.endsWith("#typing"))
        .map(p => p.nick.replace(/#typing$/,""))
        .filter(n => n !== NICK);
      $("typingInfo").textContent = typers.length ? (typers.join(", ") + " yazƒ±yor‚Ä¶") : "";
    }catch{}
  }

  /* === G√ºnl√ºk temizlik (day < bug√ºn) ‚Äì RLS Delete yoksa sessizce ba≈üarƒ±sƒ±z olur === */
  async function cleanupOldDays(){
    try{
      const q = `day=lt.${day()}`;
      await fetch(`${REST}/messages?${q}`, { method:"DELETE", headers:HDR });
      await fetch(`${REST}/presence?${q}`, { method:"DELETE", headers:HDR });
      await fetch(`${REST}/iban_validations?${q}`, { method:"DELETE", headers:HDR });
    }catch{}
  }
  let lastDay = day();
  setInterval(()=>{
    const nowDay = day();
    if(nowDay !== lastDay){
      lastDay = nowDay;
      cleanupOldDays();
      refreshGlobalCounter(); // g√ºn deƒüi≈üince saya√ß da sƒ±fƒ±rlansƒ±n
    }
  }, 60000);

  /* === Durum √ßƒ±ktƒ±sƒ± === */
  function setStatus(msg, type="error"){
    const colors = { error:"#b00020", info:"#555", ok:"#0a7d00" };
    $("chatStatus").style.color = colors[type] || colors.error;
    $("chatStatus").textContent = msg;
    console.log("[chat-status]", type.toUpperCase(), msg);
    setTimeout(()=>{ if($("chatStatus").textContent===msg) $("chatStatus").textContent=""; }, 2000);
  }

  /* === D√∂ng√ºler === */
  setInterval(loadMessages, 2000);
  setInterval(loadOnline, 5000);
  setInterval(heartbeat, 20000);
  setInterval(loadTyping, 1000);

  // ƒ∞lk y√ºklemeler
  loadMessages(); loadOnline(); loadTyping(); heartbeat(); cleanupOldDays(); loadPinned();
  // Saya√ß ilk √ßekim
  refreshGlobalCounter();

  showAdminActionsIfAny();

  // global eri≈üim istemiyorsanƒ±z bu satƒ±rlarƒ± kaldƒ±rabilirsiniz:
  window.postGlobalValidation = postGlobalValidation;
  window.refreshGlobalCounter = refreshGlobalCounter;

})();
</script>
</body>
</html>
